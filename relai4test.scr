>D
; debut journee. hotday=false
; si n > 0 and conso < 700 => fin chauffe, hotday=true
; watt<700 and n<3 => UP
; watt >200 and n>0 => DOWN

; Ã  11h. si hotday=false, on force 1res
; si hot. hotday=true. on deverrouille

http=0
preh=0
hot=0
lky=0
;prd=0
;cso=0
i=0

n1=0
m:r1=0 3
n0=0
m:r0=0 3

pic=0

; timer used to pause execution a few secs to disable flapping
; if timer is not null. pause
t:tmr=0

;;;;;;;;;;;;;;;;;;;;;;;;;;
>S

; skip if not sun hours (4h-20h). or timer set
if upsecs%10==0
and tmr==0
and hours>=4
and hours<23 {

;print %hours% %preh%

if hours==4
and preh==3 {
 print Sun day begin
 hot=0
}
preh=hours

http=1
http("192.168.1.19" "/status")
http=0

}

;;;;;;;;;;;;;;;;;;;;;;;;;;
>E
; be sure the event is our http req
if http=0 {
 break
}

n1=0
n0=0

for i 2 4 1
if pwr[i]==1 {
 r1[n1+1]=i
 n1+=1
} else {
 r0[n0+1]=i
 n0+=1
}
next

;print pwr %pwr[2]% %pwr[3]% %pwr[4]%
;print n1=%0n1% r1 %0r1[1]% %0r1[2]% %0r1[3]%
;print n0=%0n0% r0 %0r0[1]% %0r0[2]% %0r0[3]%

lky=gwr("\"power\":" 2 ,)
;prd=gwr("\"power\":" 3 ,)
;cso=lky+prd
;print lky=%lky% cso=%cso%

print TEST %lky%<-700 ELIF %lky%>200 (n0:%0n0% %0r0[1]% %0r0[2]% %0r0[3]%) (n1:%0n1% %0r1[1]% %0r1[2]% %0r1[3]%)

if lky<-700
and n0<3 {
; turn on. off instead

pic=r1[1+rnd(n1)]

print =>Power%0pic% 0
pic=1
=>Power%0pic% 0
tmr=60

} else {
; turn off. on instead
;lky=250
;n0=1
if lky>200
and n0>0 {

pic=r0[1+rnd(n0)]

print =>Power%0pic% 0
pic=1
=>Power%0pic% 1
tmr=60

}
}
